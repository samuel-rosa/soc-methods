---
title: "Pedotransfer functions for predicting carbon and organic matter content in Rio Grande do Sul, Brazil"
author: "Alessandro Samuel-Rosa, Douglas Adams Weiler, Sandro Giacomini"
date: "12 October 2017"
# bibliography: "/home/alessandrorosa/Dropbox/jabref/biblio.bib"
# csl: pesquisa-agropecuaria-brasileira.csl
output: bookdown::html_document2
---

```{r}
# load packages
library(dplyr)
library(magrittr)
library(grid)
library(latticeExtra)
library(quantreg)
library(glue)
```

# Material and Methods

## Soil data

The data can be downloaded from the Free Brazilian Repository for Open Soil Data. The dataset identification code is `ctb0029`. Here we use a copy of the data stored in folder `data`.

We create categorical variables using the clay content (`argila_naoh_esferas_pipeta`) and the organic matter content determined at the commercial soil analysis laboratory of the Universidade Federal de Santa Maria (`matorg_dicromato_30min80_eam`). For the latter, the classification is performed using the three classes used for fertilizer recommendations in Rio Grande do Sul and Santa Catarina.

```{r, echo=FALSE, message=FALSE}
camada <- readr::read_csv(
  '../data/camada.csv', locale = readr::locale(decimal_mark = ','), comment = '#unidade', na = "-")
camada <-
  camada %>% 
  mutate(textura = ifelse(argila_naoh_esferas_pipeta <= 250, '0-250', '251-500')) %>% 
  mutate(textura = ifelse(argila_naoh_esferas_pipeta > 500, '501-1000', textura)) %>% 
  mutate(textura = as.factor(textura)) %>% 
  mutate(matorg = ifelse(matorg_dicromato_30min80_eam <= 25, '<25', '26-50')) %>%
  mutate(matorg = ifelse(matorg_dicromato_30min80_eam > 50, '>50', matorg)) %>%
  mutate(matorg = as.factor(matorg)) %>% 
  mutate(observacao_id = as.factor(observacao_id))
camada
```

Data on soil observations if processed. Land use info, `terra_usoatual`, is reclassified using FAO guidelines for soil description. The following codes are used:

* FS (Floresta): Semi-deciduous forest (vegetation slightly disturbed)
* U (Vegetação secundária): Not used and not managed, vegetation strongly disturbed by clearing, burning, ploughing (secondary vegetation, mix of semi-deciduous shrubs and tall grassland)
* AA (Agricultura): Annual field cropping
* FP (Silvicultura): Plantation forestry
* HE (Campo nativo): Animal husbandry (extensive grazing)

```{r, echo=FALSE, message=FALSE}
observacao <- readr::read_csv(
  '../data/observacao.csv', locale = readr::locale(decimal_mark = ','), comment = '#unidade', na = '-')
observacao <-
  observacao %>% 
  mutate(terra_usoatual = gsub('Floresta', 'FS', .data$terra_usoatual)) %>% 
  mutate(terra_usoatual = gsub('Vegetação secundária', 'U', .data$terra_usoatual)) %>%
  mutate(terra_usoatual = gsub('Agricultura', 'AA', .data$terra_usoatual)) %>%
  mutate(terra_usoatual = gsub('Silvicultura', 'FP', .data$terra_usoatual)) %>%
  mutate(terra_usoatual = gsub('Campo nativo', 'HE', .data$terra_usoatual))
observacao
```

Compute some summary statistics: number of taxonomic classes, and range of clay content.

```{r}
data.frame(
  taxa = nlevels(as.factor(observacao$taxon_sibcs_2009)),
  min_clay = min(camada$argila_naoh_esferas_pipeta, na.rm = TRUE),
  max_clay = max(camada$argila_naoh_esferas_pipeta, na.rm = TRUE)
  )
```

### TODO: Figure 1

Location of soil observations used in this study.

### Figure 2

Key characteristics of the soil samples, such as the clay content and sampling depth, and their sampling sites, such as the soil classification and type of land use and occupation.

```{r}
p1 <- histogram(
  ~ argila_naoh_esferas_pipeta, camada, xlab = 'Clay content (g/kg)', ylab = 'Percent of total', 
  col = 'lightgray',
  panel = function (...) {
    lattice::panel.grid(v = -1, h = -1)
    lattice::panel.histogram(...)
  },
  page = function (n) {
    grid.text(label = "A)", x = unit(0.04, "npc"), y = grid::unit(0.95, "npc"))
  }) +
  latticeExtra::layer(panel.abline(v = c(250, 500), lty = 'dotted'))
p2 <- histogram(
  ~ profund_sup, camada, xlab = 'Sampling depth (cm)', ylab = 'Percent of total', col = 'lightgray',
  panel = function (...) {
    lattice::panel.grid(v = -1, h = -1)
    lattice::panel.histogram(...)
  },
  page = function (n) {
    grid.text(label = "B)", x = unit(0.04, "npc"), y = grid::unit(0.95, "npc"))
  })
p3 <- barchart(
  observacao$taxon_sibcs_2009, xlab = 'Soil classification', ylab = 'Percent of total', horizontal = FALSE, 
  col = 'lightgray', scales = list(x = list(rot = 60)),
  panel = function (...) {
    lattice::panel.grid(h = -1, v = 0)
    lattice::panel.barchart(...)
  },
  page = function (n) {
    grid.text(label = "C)", x = unit(0.04, "npc"), y = grid::unit(0.95, "npc"))
  })
p4 <- barchart(
  observacao$terra_usoatual, xlab = 'Land use and ocupation', ylab = 'Percent of total', horizontal = FALSE, 
  col = 'lightgray',
  panel = function (...) {
    lattice::panel.grid(h = -1, v = 0)
    lattice::panel.barchart(...)
  },
  page = function (n) {
    grid.text(label = "D)", x = unit(0.04, "npc"), y = grid::unit(0.95, "npc"))
  })
png("../res/fig/features-soil-samples.png", width = 480 * 4, height = 480 * 4, res = 72 * 3)
gridExtra::grid.arrange(p1, p2, p3, p4, ncol = 2)
dev.off()
```

## Analytical methods

Includes a description of the four analytical methods used:

1. Total organic carbon (TOC) by dry combustion
2. Organic carbon (OC) by wet digestion
3. Organic matter (OM) by wet digestion
4. Total organic matter (TOM) by loss on ignition

### Figure 3

Empirical probability density of carbon and organic matter content in soil samples according to the four analythical methods and the theoretical normal probability density function (dashed line).

```{r}
l <- layer(
  panel.mathdensity(
    dmath = dnorm, args = list(mean = mean(x, na.rm = TRUE), sd = sd(x, na.rm = TRUE)), n = length(x), 
    col = 'black', lty = 'dashed'))
p1 <- histogram(
  ~ carbono_fornalha_1min950_cgdct, camada, 
  xlab = expression('Total organic carbon (TOC), g kg'^'-1'), col = 'lightgray', type = "density", 
  panel = function (...) {
    panel.grid(v = -1, h = -1)
    panel.histogram(...)
  },
  page = function (n) {
    grid.text(label = "A)", x = unit(0.04, "npc"), y = grid::unit(0.95, "npc"))
  }) + l
p2 <- histogram(
  ~ carbono_dicromato_30min150_mohr, camada, 
  xlab = expression('Organic carbon (OC), g kg'^'-1'), col = 'lightgray', type = "density", 
  panel = function (...) {
    panel.grid(v = -1, h = -1)
    panel.histogram(...)
  },
  page = function (n) {
    grid.text(label = "B)", x = unit(0.04, "npc"), y = grid::unit(0.95, "npc"))
  }) + l
p3 <- histogram(
  ~ matorg_dicromato_30min80_eam, camada, 
  xlab = expression('Organic matter (OM), g dm'^'-3'), col = 'lightgray', type = "density", 
  panel = function (...) {
    panel.grid(v = -1, h = -1)
    panel.histogram(...)
  },
  page = function (n) {
    grid.text(label = "C)", x = unit(0.04, "npc"), y = grid::unit(0.95, "npc"))
  }) + l
p4 <- histogram(
  ~ matorg_fornalha_120min360_massa, camada, 
  xlab = expression('Total organic matter (TOM), g kg'^'-1'), col = 'lightgray', type = "density", 
  panel = function (...) {
    panel.grid(v = -1, h = -1)
    panel.histogram(...)
  },
  page = function (n) {
    grid.text(label = "D)", x = unit(0.04, "npc"), y = grid::unit(0.95, "npc"))
  }) + l
png("../res/fig/carbon-histograms.png", width = 480 * 4, height = 480 * 4, res = 72 * 3)
gridExtra::grid.arrange(p1, p2, p3, p4, ncol = 2)
dev.off()
```

### Figure 4

Scatter plot matrix of the carbon and organic matter content measured using four different analythical methods and their relation to the total clay content and class (0-250, 250-500, 500-1000 g/kg). The solid line represents a perfect 1:1 linear relation, while the dashed line is the observed empirical linear relation between variables.

```{r}
png("../res/fig/scatter-plot-matrix.png", width = 480 * 4, height = 480 * 4, res = 72 * 3)
camada %>% 
  select(carbono_fornalha_1min950_cgdct, carbono_dicromato_30min150_mohr, matorg_dicromato_30min80_eam, 
         matorg_fornalha_120min360_massa, argila_naoh_esferas_pipeta) %>% 
  splom(groups = camada$textura, grid = TRUE, auto.key = list(columns = 3), xlab = '',
        varnames = c(expression(atop('TOC', 'g kg'^'-1')), expression(atop('OC', 'g kg'^'-1')),
                     expression(atop('OM', 'g dm'^'-3')), expression(atop('TOM', 'g kg'^'-1')),
                     expression(atop('Clay', 'g kg'^'-1')))) +
  latticeExtra::layer(panel.abline(a = 0, b = 1)) +
  latticeExtra::layer(panel.lmline(x = x, y = y, lty = 'dashed'))
dev.off()
```

# Pedotransfer functions

<!-- and that standard significance tests are resistant to the violation of the iid-normal assumption [@Webster2001; ]. -->

<!-- enabling estimating the most likely value of a soil property along with an uncertainty measure, e.g. the prediction interval. -->

# Results and Discussion

```{r}
densidade <- 
  read.table("../data/densidade.csv", sep = "\t", dec = ",", head = TRUE) %>% 
  reshape(direction = "long", idvar = "id", varying = list(4:6), v.names = "d") %>% 
  mutate(id = as.factor(id), clay = as.numeric(clay))
fit1 <- nlme::lme(d ~ som + clay, data = densidade, random = ~1|id)
summary(fit)
plot(fit)
nlme::intervals(fit)
cbind(fit2$fitted, obs = densidade$d, fit = fitted(fit2)) %>% round(3)

fit2 <- lm(d ~ som + clay, data = densidade)
```


```{r}
summary(fit1)
```


```{r}
summary(fit2)
```

```{r, fig.asp=1}
mo <- log1p(round((camada$mo_wet * camada$densidade) / 10, 1))
clay <- camada$argila_naoh_pipeta
dens <- camada$densidade
plot(dens ~ clay)
fit <- lm(dens ~ mo*clay)
summary(fit)
```

```{r}
plot(fit, 1)
```


```{r, fig.asp=1}
plot(fit$fitted.values ~ dens)
abline(lm(fit$fitted.values ~ dens), col = "red")
abline(a = 0, b = 1)
```

```{r, echo=FALSE}
# Define formulas
forms <- c("carbono_dry", "carbono_wet", "mo_wet", "mo_loi")
forms <- expand.grid(forms, forms)
forms <- 
  forms[forms[, 1] != forms[, 2], ] %>% 
  apply(1, function (x) reformulate(x[1], x[2]))
names(forms) <- sapply(forms, function (x) x)
```

```{r calibrate_models, echo=FALSE}
# Function to calibrate models for different values of tau
calibrate_models <-
  function (tau) {
    fit <- list()
    for (i in 1:length(forms)) {
      fit[[i]] <- rq(forms[[i]], tau = tau, data = camada, method = 'fn')
    }
    names(fit) <- names(forms)
    fit
  }
```

```{r, echo=FALSE}
# Calibrate models for tau = {0.025, 0.5, 0.975}
fit_lower <- calibrate_models(0.025)
fit_median <- calibrate_models(0.5)
fit_upper <- calibrate_models(0.975)
```

```{r prepare_beta_table, echo=FALSE}
# Function to prepare table with estimated model parameters (betas)
prepare_beta_table <-
  function (fit) {
    betas <- lapply(fit, function (x) summary(x)$coefficients)
    betas <- do.call(rbind, betas) %>% round(4)
    betas <- data.frame(PTF = rep(names(forms), each = 2), Beta = rownames(betas), betas)
    betas$PTF <- glue('**{betas$PTF}**')
    betas$PTF[seq(2, length(betas$PTF), 2)] <- ''
    rownames(betas) <- NULL
    colnames(betas)[3:5] <- c('Estimate', 'Lower', 'Upper')
    colnames(betas) <- glue('**{colnames(betas)}**')
    betas
  }
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Table with estimated model parameters por tau = 0.5
tau <- 0.5
betas_median <- prepare_beta_table(fit_median)
panderOptions('round', rep(4, ncol(betas_median)))
panderOptions('table.split.cells', rep(100 / ncol(betas_median), ncol(betas_median)))
pander(betas_median, caption = glue('(\\#tab:coefficients-median) Estimated coefficients of carbon and organic matter pedotransfer functions and their respective confidence interval. Coefficients are as follows: $\\Beta_0$ -- intercept, $\\Beta_1$ -- soil carbon and organic matter content.'))
```

```{r get_y, echo=FALSE}
# Function to extract the name of the dependent variable in a formula
get_y <- function (form) {
  terms(form, simplify = T)[[2]] %>% as.character()
}
```

```{r cross-validation, echo=FALSE}
# Cross-validate models
cv <- list()
for (j in 1:length(forms)) {
  err <- vector()
  for (i in 1:nrow(camada)) {
    y <- camada[[get_y(forms[[j]])]]
    resid <- mean(y) - y
    cv_fit <- rq(forms[[j]], data = camada[-i, ], method = 'fn')
    err[i] <- predict(cv_fit, camada[i, ]) - y[i]
  }
  cv[[j]] <- data.frame(
    ME = mean(err),
    MedE = median(err),
    MAE = mean(abs(err)),
    MedAE = median(abs(err)),
    MSE = mean(err * err), 
    MedSE = median(err * err), 
    AVE = 1 - (sum(err * err) / sum(resid * resid)))
}
names(cv) <- names(forms)
cv <- do.call(rbind, cv) %>% round(4)
```

```{r, echo=FALSE}
colnames(cv) <- glue('**{colnames(cv)}**')
panderOptions('round', rep(4, ncol(cv)))
panderOptions('table.split.cells', rep(100 / ncol(cv), ncol(cv)))
pander(cv, caption = '(\\#tab:cross-validation) Leave-one-out cross-validation results of soil carbon and organic matter pedotransfer functions. Error statistics are as follows: ME -- mean error, MedE -- median error, MAE -- mean absolute error, MedAE -- median absolute error, MSE -- mean square error, MedSE -- median square error, AVE -- amount of variance explained.')
```

The estimated parameters of the quantile regressions for the lower ($\tau = 0.025$) and upper ($\tau = 0.975$) 
bounds of the 90% prediction interval of the carbon and organic matter pedotransfer functions are shown in 
Tables \@ref{tab:coefficients-lower} and \@ref{tab:coefficients-upper}, respectively.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Table with estimated model parameters por tau = 0.025
tau <- 0.025
betas_lower <- prepare_beta_table(fit_lower)
panderOptions('round', rep(4, ncol(betas_lower)))
panderOptions('table.split.cells', rep(100 / ncol(betas_lower), ncol(betas_lower)))
pander(betas_lower, caption = glue('(\\#tab:coefficients-lower) Estimated coefficients for computing the lower bound ($\\tau = {tau}$) of the prediction interval of carbon and organic matter pedotransfer functions. Coefficients are as follows: $\\Beta_0$ -- intercept, $\\Beta_1$ -- soil carbon and organic matter content.'))
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Table with estimated model parameters por tau = 0.975
tau <- 0.975
betas_upper <- prepare_beta_table(fit_upper)
panderOptions('round', rep(4, ncol(betas_upper)))
panderOptions('table.split.cells', rep(100 / ncol(betas_upper), ncol(betas_upper)))
pander(betas_upper, caption = glue('(\\#tab:coefficients-upper) Estimated coefficients for computing the upper bound ($\\tau = {tau}$) of the prediction interval of carbon and organic matter pedotransfer functions. Coefficients are as follows: $\\Beta_0$ -- intercept, $\\Beta_1$ -- soil carbon and organic matter content.'))
```

# References